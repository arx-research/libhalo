<!DOCTYPE html>
<html>
<head>
    <!--
    LibHaLo - Programmatically interact with HaLo tags from the web browser, mobile application or the desktop.
    Copyright by Arx Research, Inc., a Delaware corporation
    License: MIT
    -->
    <title>LibHaLo Demo</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

    <script type="text/javascript">
        // ensure the library is always fully reloaded
        document.write('<script src="../dist/libhalo.js?_v=' + (Math.random() + '') + '"></scr' + 'ipt>');
    </script>
</head>
<body>
<div class="container">
    <h1>LibHaLo Demo</h1>
    <h2>Using gateway</h2>
    <p class="text-muted">
        Establishing connection between the PC and smartphone. The commands will be initiated by the PC,
        with the smartphone used solely as the NFC reader. Finally, the command results will arrive back to PC.
    </p>
    <pre id="statusText"></pre>

    <div class="mb-3">
        <label class="form-label">Message to be signed with ECDSA/Keccak (hex-encoded)</label>
        <input type="text" class="form-control" id="message" value="">
    </div>
    <button class="btn btn-secondary" onclick="btnInitiateSessClicked();">Initiate session</button>
    <button class="btn btn-secondary" onclick="btnSignMessageClicked();">Sign message using key #1</button>
    <button class="btn btn-secondary" onclick="btnOneShotClicked();">Initiate&amp;sign in one shot</button>

    <img id="qr">

    <script type="text/javascript">
        // generate random message on load
        let rnd = new Uint8Array(6);
        crypto.getRandomValues(rnd);
        document.getElementById('message').value = arr2hex(rnd);

        async function btnSignMessageClicked() {
            let gate = new HaloGateway('localhost:32842', '192.168.0.173:32842', () => null);
            window.gate = gate;

            try {
                let qr = await gate.startPairing();
                document.getElementById('qr').src = qr;
            } catch (e) {
                console.error('fail');
            }

            console.log('pairing started');

            try {
                await gate.waitConnected();
            } catch (e) {
                console.error('fail2');
            }

            console.log('pairing completed');

            try {
                let res = await window.gate.ws.sendRequest({"type": "request_cmd", "payload": {"name": "sign", "message": "010203", "keyNo": 1}});
                console.log('res', res);
            } catch (e) {
                console.error('wtf');
                console.error(e);
            }

            console.log('completed');
        }

        async function btnInitiateSessClicked() {
            try {
                await window.gate.ws.sendRequest({"type": "request_cmd", "payload": {"name": "sign", "message": "010203", "keyNo": 1}});
            } catch (e) {
                console.error('wtf');
                console.error(e);
            }
        }
    </script>
</div>
</body>
</html>
